FROM docker.io/library/maven:3-eclipse-temurin-11-noble

RUN set -eux; \
	useradd -d /home/bench -m -s /bin/bash bench; \
	echo bench:bench | chpasswd; \
	mkdir /benchmark; \
	git clone https://github.com/OWASP-Benchmark/BenchmarkJava.git; \
	sed -i -e 's@<ratchetFrom>origin/master</ratchetFrom>@<!-- <ratchetFrom>origin/master</ratchetFrom> -->@g' BenchmarkJava/pom.xml; \
	cp -rt /benchmark \
		BenchmarkJava/src \
		BenchmarkJava/.mvn \
		BenchmarkJava/.keystore \
		BenchmarkJava/pom.xml \
		BenchmarkJava/DevStyleXml.prefs \
		BenchmarkJava/DevStyleHtml.prefs \
		; \
	rm -r BenchmarkJava

WORKDIR /benchmark

RUN set -eux;  \
	mvn initialize; \
	mvn package cargo:configure -Pdeploy -Drunenv=remote; \
	chown -R bench .;

EXPOSE 8443
CMD mvn package cargo:run -Pdeploy -Drunenv=remote

# smoke test
RUN timeout 120 mvn package cargo:run -Pdeploy -Drunenv=remote || [ $? -eq 124 ];
